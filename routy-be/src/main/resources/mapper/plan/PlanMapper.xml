<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.c4.routy.domain.plan.mapper.PlanMapper">

    <!-- =======================================================
         여행 상세보기 (PlanDetailResponseDTO)
         ======================================================= -->

    <!-- 활동(하루 안의 장소 일정) -->
    <resultMap id="PlanActivityResult" type="com.c4.routy.domain.plan.dto.PlanActivityDTO">
        <id property="travelId" column="travel_id"/>
        <result property="title" column="travel_title"/>
        <result property="place" column="address_name"/>
        <result property="tag" column="category_group_name"/>
        <result property="url" column="place_url"/>
    </resultMap>

    <!-- Day 단위 일정 묶음 -->
    <resultMap id="PlanDayResult" type="com.c4.routy.domain.plan.dto.PlanDayDTO">
        <id property="dayId" column="duration_id"/>
        <result property="dayNo" column="day"/>
        <result property="date" column="day_date"/>
        <collection property="activities"
                    ofType="com.c4.routy.domain.plan.dto.PlanActivityDTO"
                    resultMap="PlanActivityResult"/>
    </resultMap>

    <!-- 여행 전체 상세 -->
    <resultMap id="PlanDetailResult" type="com.c4.routy.domain.plan.dto.PlanDetailResponseDTO">
        <id property="planId" column="plan_id"/>
        <result property="title" column="plan_title"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="destination" column="region_name"/>
        <result property="theme" column="theme"/>
        <collection property="dayList"
                    ofType="com.c4.routy.domain.plan.dto.PlanDayDTO"
                    resultMap="PlanDayResult"/>
    </resultMap>


    <!-- =======================================================
         일정 상세조회 쿼리 (플랫 구조)
         ======================================================= -->
    <select id="selectPlanDetail" parameterType="int" resultMap="PlanDetailResult">
        SELECT
            p.plan_id,
            p.plan_title,
            p.start_date,
            p.end_date,
            r.region_name,
            r.theme,
            d.duration_id,
            d.day,
            DATE_ADD(p.start_date, INTERVAL (d.day - 1) DAY) AS day_date,
            t.travel_id,
            t.title AS travel_title,
            t.address_name,
            t.category_group_name,
            t.place_url
        FROM TBL_PLAN p
                 LEFT JOIN TBL_REGION r ON p.region_id = r.region_id
                 LEFT JOIN TBL_DURATION d ON p.plan_id = d.plan_id
                 LEFT JOIN TBL_TRAVEL t ON d.duration_id = t.duration_id
        WHERE p.plan_id = #{planId}
        ORDER BY d.day ASC, t.travel_order ASC
    </select>


    <!-- =======================================================
         마이페이지: 내 일정 목록 (PlanSummaryResponseDTO)
         ======================================================= -->
    <select id="selectUserPlans" resultType="map">
        SELECT
            p.plan_id,
            p.plan_title,
            p.start_date,
            p.end_date,
            r.region_name,
            r.theme,
            tr.transport_name AS transportation
        FROM TBL_PLAN p
                 LEFT JOIN TBL_REGION r ON p.region_id = r.region_id
                 LEFT JOIN TBL_TRANSPORT tr ON p.plan_id = tr.plan_id
        WHERE p.user_id = #{userId}
          AND p.is_deleted = 0
        ORDER BY p.start_date ASC
    </select>

</mapper>
